{% extends '/templates/default.html' %}

{% block links -%}
<link rel="stylesheet" href="/static/css/nav.css">
{%- endblock %}

{% block title %}
Inventory Items
{% endblock %}

{% block content %}
<h1>Inventory default</h1>
<notification-list></notification-list>
<items-table></items-table>
<modal-dialog id="itemEditor">
    <div class="wrapper">
        <item-editor></item-editor>
    </div><!-- .wrapper -->
</modal-dialog>
{% endblock %}

{% block scripts %}
<script type="module" src="/static/js/components/notification.list.js"></script>
<script type="module" src="/static/js/components/inventory/items.table.js"></script>
<script type="module" src="/static/js/components/inventory/item.editor.js"></script>
<script type="module" src="/static/js/api/inventory.js"></script>
<script type="module" src="/static/js/modal.dialog.js"></script>
<script src="https://unpkg.com/rxjs/bundles/rxjs.umd.min.js"></script>
<script type="module">
'use strict';
import { Inventory } from '/static/js/api/inventory.js';

(function(){
    const { fromEvent, from, of } = rxjs;
    const {
        debounceTime,
        filter,
        distinctUntilChanged,
        map,
        switchMap,
        tap
    } = rxjs.operators;

    const currentClientId = window.variables.currentClient.id;

    const n = document.querySelector('notification-list');
    const itbl = document.querySelector('items-table');
    itbl.setOptions({
        allowAdd: true,
        multiselect: false
    });

    const fetchItems = (clientId, query) => {
        return Inventory.items(clientId, query);
    };

    fetchItems(currentClientId, '').then((data) => {
        if (data.status == 'success') {
            const o = JSON.parse(data.json);
            itbl.setItems(o.items, o.filter);
        } else {
            n.add('error', data.message);
        }
    });

    fromEvent(itbl, 'onfilteritems')
        .pipe(
            map(e => e.detail),
            debounceTime(250),
            filter(query => query.length > 3),
            distinctUntilChanged(),
            switchMap(query => from(fetchItems(currentClientId, query))),
            tap(e => {
                if (e.status == 'success') {
                    const o = JSON.parse(e.json);
                    itbl.setItems(o.items, o.filter);
                } else {
                    n.add('error', e.message, 3000);
                }
            })
        )
        .subscribe();
    
    itbl.addEventListener('onadditem', function(e) {
        const modal = document.querySelector('modal-dialog#itemEditor');
        const dlg = modal.show();
        
        dlg.addEventListener('onsaveitem', function(e) {
            const item = e.detail;
            Inventory.itemAdd(window.variables.currentClient.id, item)
                .then((data) => {
                    if (data.status == 'success') {
                        fetchItems(currentClientId, '').then((data) => {
                            if (data.status == 'success') {
                                const o = JSON.parse(data.json);
                                itbl.setItems(o.items, o.filter);
                            } else {
                                n.add('error', data.message);
                            }
                        });
                    } else {
                        n.add('error', data.message);
                    }
                });
            modal.hide();
        });

        dlg.addEventListener('oncancelitem', function(e) {

        });
    });
})();
</script>
{% endblock scripts %}