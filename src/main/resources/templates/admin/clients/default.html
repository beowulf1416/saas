{% extends '/templates/layout.html' %}

{% block title -%}
Administer Clients
{%- endblock %}

{% block content %}
<notification-list id="notifications"></notification-list>
<h1>Admin Clients Default</h1>
<clients-table id="clientTbl"></clients-table>
<modal-dialog id="clientDlg">
    <client-editor id="clientEditor"></client-editor>
</modal-dialog>
<client-users-table id="clientUsersTbl"></client-users-table>
<modal-dialog id="usersDlg">
    <div id="userAddWrapper">
        <form class="form-user-add">
            <fieldset>
                <legend>User</legend>
                <notification-list id="formNotifications"></notification-list>
                <div class="form-group">
                    <label for="email">Email</label>
                    <input type="email" id="email" name="email" class="form-input-email" title="Email address" />
                </div><!-- .form-group -->
            </fieldset>
            <button type="button" id="btnAdd" title="Add User">Add</button>
            <button type="button" id="btnCancel" title="Cancel">Cancel</button>
        </form>
    </div><!-- #userAddWrapper -->
</modal-dialog>
<roles-table id="rolesTbl"></roles-table>
<modal-dialog id="roleDlg">
    <div id="roleAddWrapper">
        <notification-list></notification-list>
        <form class="form-role-add">
            <fieldset>
                <legend>Role</legend>
                <div class="form-group">
                    <label for="roleName">Name</label>
                    <input type="text" id="roleName" name="roleName" class="form-input text" title="Role Name" />
                </div><!-- .form-group -->
            </fieldset>
            <button type="button" id="btnAddRole" title="Add Role">Add</button>
            <button type="button" id="btnCancelRole" title="Cancel">Cancel</button>
        </form>
    </div><!-- #roleAddWrapper -->
</modal-dialog>
<permissions-table id="permissionsTbl"></permissions-table>
{% endblock %}

{% block scripts %}
<script type="module" src="/static/js/components/notification.list.js"></script>
<script type="module" src="/static/js/components/admin/clients/clients.table.js"></script>
<script type="module" src="/static/js/components/admin/clients/client.edit.js"></script>
<script type="module" src="/static/js/components/admin/clients/client.users.table.js"></script>
<script type="module" src="/static/js/components/roles.table.js"></script>
<script type="module" src="/static/js/components/permissions.table.js"></script>
<script type="module" src="/static/js/api/admin.clients.js"></script>
<script type="module" src="/static/js/modal.dialog.js"></script>
<script type="module">
'use strict';
import { AdminClients } from '/static/js/api/admin.clients.js';

(function(){
    const notifications = document.getElementById('notifications');

    let currentClientId = '';
    let currentUserId = '';
    let currentRoleId = '';

    const ctbl = document.getElementById('clientTbl');
    const utbl = document.getElementById('clientUsersTbl');
    const rolesTbl = document.getElementById('rolesTbl');
    const permissionsTbl = document.getElementById('permissionsTbl');

    // const dlg = document.getElementById('clientDlg');
    // const udlg = document.getElementById('usersDlg');

    ctbl.addEventListener('onaddclient', function(e) {
        const modal = document.getElementById('clientDlg');
        const dlg = modal.show();
        const editor = dlg.querySelector('.dialog-wrapper client-editor');

        editor.addEventListener('save', function(e) {
            ctbl.refresh();
            modal.hide();
        });
        editor.addEventListener('cancel', function(e) {
            modal.hide();
        });
        editor.addEventListener('error', function(e) {
            notifications.add('error', e.message, 3000);
            console.error(e);
        });
    });

    ctbl.addEventListener('onselectclient', function(e) {
        currentClientId = e.detail.clientId;

        AdminClients.users(currentClientId, function(e) {
            if (e.status == 'success') {
                utbl.setUsers(JSON.parse(e.json), { allowAdd: true });
            } else {
                notifications.add('error', e.message);
            }
        });

        AdminClients.roles(currentClientId, function(e) {
            if (e.status == 'success') {
                rolesTbl.setRoles(JSON.parse(e.json), { allowAdd: true });
            } else {
                notifications.add('error', e.message);
            }
        });
    });

    utbl.addEventListener('onadduser', function(e) {
        const modal = document.getElementById('usersDlg');
        const dlg = modal.show();
        const fNotifications = dlg.querySelector('notification-list');
        const bAdd = dlg.querySelector('form.form-user-add button#btnAdd');
        bAdd.addEventListener('click', function(e) {
            if (currentClientId == '') {
                fNotifications.add('error', 'Please select a client', 5000);
                console.log('Please select a client');
            } else {
                const tEmail = modal.querySelector('form.form-user-add input#email');
                AdminClients.addUserToClient(currentClientId, tEmail.value, function(e) {
                    if (e.status == 'success') {
                        fNotifications.add('success', 'user added to client', 3000);
                        utbl.refresh();
                        modal.hide();
                    } else {
                        fNotifications.add('error', e.message, 3000);
                        console.error(e.message);
                    }
                });
            }
        });

        const bCancel = dlg.querySelector('form.form-user-add button#btnCancel');
        bCancel.addEventListener('click', function(e) {
            modal.hide();
        });
    });

    utbl.addEventListener('onselectuser', function(e) {
        currentUserId = e.detail.userId;
        AdminClients.userRoles(currentClientId, currentUserId, function(e) {
            if (e.status == 'success') {
                rolesTbl.setRoles(JSON.parse(e.json), { allowAdd: true });
            } else {
                notifications.add('error', e.message);
            }
        });
    });

    rolesTbl.addEventListener('onselectrole', function(e) {
        currentRoleId = e.detail.roleId;
        AdminClients.rolePermissions(currentClientId, currentRoleId, function(e) {
            if (e.status == 'success') {
                permissionsTbl.setPermissions(JSON.parse(e.json));
            } else {
                notifications.add('error', e.message);
            }
        });
    });

    rolesTbl.addEventListener('onaddrole', function(e) {
        const modal = document.getElementById('roleDlg');
        const dlg = modal.show();
        const bAdd = dlg.querySelector('form.form-role-add button#btnAddRole');
        bAdd.addEventListener('click', function(e) {
            const role = dlg.querySelector('input#roleName');
            AdminClients.addRole(currentClientId, role.value, function(e) {
                if (e.status == 'success') {
                    modal.hide();
                } else {
                    const notifications = dlg.querySelector('notification-list');
                    notifications.add('error', e.message);
                }
            });
        });

        const bCancel = dlg.querySelector('form.form-role-add button#btnCancelRole');
        bCancel.addEventListener('click', function(e) {
            modal.hide();
        });
    });
})();
</script>
{% endblock scripts %}